<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Locker Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS: ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ß‡πá‡∏ö --- */
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }

        .container { 
            width: 100%; 
            max-width: 420px; 
            position: relative; 
        }

        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { color: #2c3e50; margin-bottom: 5px; font-size: 26px; }
        h2 { color: #34495e; font-size: 20px; margin-bottom: 20px; }
        p { color: #7f8c8d; margin-bottom: 25px; font-size: 14px; }

        input { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            border: 2px solid #ecf0f1; 
            border-radius: 12px; 
            font-size: 18px; 
            text-align: center; 
            box-sizing: border-box; 
            transition: 0.3s;
            outline: none;
            font-family: 'Sarabun', sans-serif;
        }
        
        input:focus { border-color: #3498db; }

        button { 
            width: 100%; 
            padding: 15px; 
            margin-top: 10px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold; 
            color: white; 
            transition: 0.2s; 
            font-family: 'Sarabun', sans-serif;
        }

        button:active { transform: scale(0.98); }

        /* ‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ */
        .btn-main { background: #2c3e50; box-shadow: 0 4px 0 #1a252f; }
        .btn-sender { background: #e67e22; box-shadow: 0 4px 0 #d35400; margin-bottom: 15px; }
        .btn-receiver { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-confirm { background: #27ae60; box-shadow: 0 4px 0 #219150; }
        .btn-back { background: transparent; color: #95a5a6; font-size: 14px; width: auto; box-shadow: none; margin-top: 20px; }
        .btn-back:hover { color: #7f8c8d; text-decoration: underline; }

        /* Grid ‡∏ï‡∏π‡πâ */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
        .l-btn { 
            padding: 15px; 
            border-radius: 12px; 
            border: 2px solid #eee; 
            background: white; 
            color: #333; 
            font-size: 14px;
            transition: 0.2s;
        }
        .l-btn.available { background: #e8f5e9; border-color: #2ecc71; color: #27ae60; }
        .l-btn.available:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.2); }
        .l-btn.occupied { background: #ffebee; border-color: #e74c3c; color: #c0392b; cursor: not-allowed; opacity: 0.6; }

        /* Utility Classes */
        .hidden { display: none; }
        
        /* OTP Box */
        .otp-display-box {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed #ffeeba;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .otp-code { font-size: 32px; font-weight: bold; display: block; margin-top: 5px; letter-spacing: 5px; }

        /* Result Box */
        .res-box { padding: 20px; border-radius: 12px; margin-top: 15px; animation: fadeIn 0.3s; }
        .success { background: #e8f5e9; color: #27ae60; border: 1px solid #c8e6c9; }
        .error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }

    </style>
</head>
<body>

<div class="container">

    <div id="pageLogin" class="card">
        <h1>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
        <p>‡∏£‡∏∞‡∏ö‡∏ö Smart Locker ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
        <input type="tel" id="loginPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡πÄ‡∏ä‡πà‡∏ô 0812345678)" maxlength="10">
        <div id="msgLogin" style="color:#e74c3c; font-size:14px; margin-top:5px;"></div>
        <button class="btn-main" onclick="getOTP()">‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™ OTP</button>
    </div>

    <div id="pageOTP" class="card hidden">
        <h1>üí¨ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h1>
        <div id="otpDisplayArea" class="otp-display-box"></div>
        
        <input type="text" id="otpInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô" maxlength="6">
        <div id="msgOtp" style="color:#e74c3c; font-size:14px; margin-top:5px;"></div>
        
        <button class="btn-confirm" onclick="verifyOTP()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
        <button class="btn-back" onclick="location.reload()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå</button>
    </div>

    <div id="pageMenu" class="card hidden">
        <h1>üì¶ Smart Locker</h1>
        <p id="welcomeUser">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
        <button class="btn-sender" onclick="nav('sender')">üöö ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á)</button>
        <button class="btn-receiver" onclick="nav('receiver')">üéÅ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)</button>
        <button class="btn-back" onclick="location.reload()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="pageSender" class="card hidden">
        <div style="text-align:left;"><button class="btn-back" style="margin:0;" onclick="nav('menu')">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button></div>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</h2>
        <div id="lockerGrid" class="grid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        
        <div id="reserveForm" class="hidden" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
            <p>‡∏ù‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏π‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: <b id="targetLocker" style="font-size:22px; color:#e67e22;"></b></p>
            <input type="tel" id="receiverPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)" maxlength="4">
            <button class="btn-confirm" onclick="doReserve()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å</button>
        </div>
    </div>

    <div id="pageReceiver" class="card hidden">
        <div style="text-align:left;"><button class="btn-back" style="margin:0;" onclick="nav('menu')">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button></div>
        <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏</h2>
        <input type="tel" id="searchPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)" maxlength="4">
        <button class="btn-receiver" onclick="doSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div id="searchResult"></div>
    </div>

</div>

<script>
    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    const API_URL = "https://script.google.com/macros/s/AKfycbwcqSbwBWjZqGT7_k-XOIfe6x9Ia9UrdNd4mWquWBLCNl0QmD_p7vtIqN7oABsKGp8HmA/exec";

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö
    let myOTP = null;
    let currentUser = "";
    let selectedLockerNum = null;

    /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Login & OTP --- */
    function getOTP() {
        const phone = document.getElementById('loginPhone').value;
        if(phone.length < 9) {
            document.getElementById('msgLogin').innerText = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
            return;
        }
        
        // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç OTP 6 ‡∏´‡∏•‡∏±‡∏Å
        myOTP = Math.floor(100000 + Math.random() * 900000);
        currentUser = phone;
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ OTP ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô
        document.getElementById('otpDisplayArea').innerHTML = `‡∏£‡∏´‡∏±‡∏™ OTP ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠<span class="otp-code">${myOTP}</span>`;
        document.getElementById('msgLogin').innerText = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå error ‡πÄ‡∏Å‡πà‡∏≤
        
        switchPage('pageOTP');
    }

    function verifyOTP() {
        const input = document.getElementById('otpInput').value;
        if(input == myOTP) {
            document.getElementById('welcomeUser').innerText = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏Ñ‡∏∏‡∏ì " + currentUser;
            switchPage('pageMenu');
        } else {
            document.getElementById('msgOtp').innerText = "‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
        }
    }

    /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Smart Locker --- */
    function nav(target) {
        if(target === 'sender') fetchLockers();
        if(target === 'receiver') {
             document.getElementById('searchResult').innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡πà‡∏≤
             document.getElementById('searchPhone').value = "";
        }
        switchPage(target === 'sender' ? 'pageSender' : 'pageReceiver');
    }

    // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏π‡πâ
    async function fetchLockers() {
        const grid = document.getElementById('lockerGrid');
        grid.innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>";
        try {
            const res = await fetch(API_URL + "?action=checkStatus");
            const data = await res.json();
            
            grid.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° loading
            data.forEach(item => {
                const btn = document.createElement('button');
                const isFree = item.status === 'Available';
                
                btn.className = `l-btn ${isFree ? 'available' : 'occupied'}`;
                btn.innerHTML = `‡∏ï‡∏π‡πâ ${item.locker}<br>${isFree ? '‚úÖ ‡∏ß‡πà‡∏≤‡∏á' : '‚ùå ‡πÄ‡∏ï‡πá‡∏°'}`;
                btn.disabled = !isFree;
                
                if(isFree) {
                    btn.onclick = () => {
                        selectedLockerNum = item.locker;
                        document.getElementById('targetLocker').innerText = item.locker;
                        document.getElementById('reserveForm').classList.remove('hidden');
                        document.getElementById('reserveForm').scrollIntoView({behavior: 'smooth'});
                    };
                }
                grid.appendChild(btn);
            });
        } catch(e) {
            grid.innerHTML = `<p style="color:red">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ<br>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ URL Script</p>`;
        }
    }

    // ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á
    async function doReserve() {
        const rPhone = document.getElementById('receiverPhone').value;
        if(rPhone.length < 4) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö 4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢");
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô loading
        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        btn.disabled = true;

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'reserve',
                    locker: selectedLockerNum,
                    phone: rPhone
                })
            });
            alert("‚úÖ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            switchPage('pageMenu');
        } catch(e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        }
        
        btn.innerText = oldText;
        btn.disabled = false;
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏
    async function doSearch() {
        const sPhone = document.getElementById('searchPhone').value;
        const resBox = document.getElementById('searchResult');
        if(sPhone.length < 4) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå 4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢");

        resBox.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
        try {
            const res = await fetch(`${API_URL}?action=find&phone=${sPhone}`);
            const data = await res.json();
            
            if(data.found) {
                resBox.innerHTML = `
                    <div class="res-box success">
                        <h3>üéâ ‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏!</h3>
                        <p>‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <b>‡∏ï‡∏π‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${data.locker}</b></p>
                        <button class="btn-confirm" onclick="clearLocker('${data.locker}')">
                            üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ)
                        </button>
                    </div>`;
            } else {
                resBox.innerHTML = `<div class="res-box error">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</div>`;
            }
        } catch(e) {
            resBox.innerHTML = "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
        }
    }

    // ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ
    async function clearLocker(num) {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á")) return;
        
        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'clear', locker: num })
            });
            alert("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£! ‡∏ï‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
            switchPage('pageMenu');
        } catch(e) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏π‡πâ");
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Helper)
    function switchPage(pageId) {
        ['pageLogin', 'pageOTP', 'pageMenu', 'pageSender', 'pageReceiver'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(pageId).classList.remove('hidden');
    }
</script>

</body>
</html>