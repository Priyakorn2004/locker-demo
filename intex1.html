<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locker System</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; text-align: center; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .hidden { display: none; }
        .btn-main { padding: 15px 30px; font-size: 18px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 18px; margin-top: 15px; }
        .btn-back { background-color: #6c757d; margin-top: 20px; padding: 10px 20px; color: white; border: none; border-radius: 5px; cursor: pointer;}
        
        .locker-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
        .l-btn { padding: 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; transition: 0.3s; width: 100%; }
        
        .Available { background-color: #28a745; color: white; cursor: pointer; }
        .Available:hover { background-color: #218838; transform: scale(1.05); }
        .Occupied { background-color: #dc3545; color: white; cursor: not-allowed; opacity: 0.7; }
        
        input { padding: 10px; font-size: 16px; width: 80%; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .status-box { margin-top: 15px; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="homePage">
        <h1>üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏£‡πå‡∏ó‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏Å‡∏≠‡∏£‡πå</h1>
        <button class="btn-main" onclick="nav('sender')">‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á (‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á)</button>
        <button class="btn-main" style="background-color: #ffc107; color: #000;" onclick="nav('receiver')">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö)</button>
    </div>

    <div id="senderPage" class="hidden">
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å</h2>
        <div id="lockerGrid" class="locker-grid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

        <div id="reserveForm" class="hidden" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡∏π‡πâ: <span id="targetLocker" style="color:blue"></span></h3>
            <input type="tel" id="phoneInput" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (4 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢)" maxlength="10">
            <br>
            <button class="btn-main" style="background-color: #28a745;" onclick="doReserve()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å</button>
        </div>
        <button class="btn-back" onclick="nav('home')">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <div id="receiverPage" class="hidden">
        <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
        <p>‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á</p>
        <input type="tel" id="phoneSearch" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
        <br>
        <button class="btn-main" onclick="doSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <div id="searchResult"></div>
        <button class="btn-back" onclick="nav('home')">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyYeqP-Zwcg2q44hb2hIcUTBxJ3bZSNgvFuEgj86C_qDJztKReJdNn7MU72cFIyMQ9fUA/exec"; 

    let selectedLocker = null;

    function nav(page) {
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('senderPage').classList.add('hidden');
        document.getElementById('receiverPage').classList.add('hidden');
        document.getElementById('reserveForm').classList.add('hidden');
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        document.getElementById('phoneInput').value = '';
        document.getElementById('phoneSearch').value = '';
        document.getElementById('searchResult').innerHTML = '';

        if (page === 'home') document.getElementById('homePage').classList.remove('hidden');
        if (page === 'sender') {
            document.getElementById('senderPage').classList.remove('hidden');
            loadLockers();
        }
        if (page === 'receiver') document.getElementById('receiverPage').classList.remove('hidden');
    }

    async function loadLockers() {
        const grid = document.getElementById('lockerGrid');
        grid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        try {
            const res = await fetch(SCRIPT_URL + "?action=checkStatus");
            const data = await res.json();
            grid.innerHTML = "";
            data.forEach(item => {
                const btn = document.createElement('button');
                btn.className = `l-btn ${item.status}`;
                btn.innerHTML = `‡∏ï‡∏π‡πâ ${item.locker}<br><span style="font-size:12px">${item.status === 'Available' ? '‡∏ß‡πà‡∏≤‡∏á' : '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á'}</span>`;
                btn.disabled = item.status !== 'Available';
                if (item.status === 'Available') {
                    btn.onclick = () => {
                        selectedLocker = item.locker;
                        document.getElementById('targetLocker').innerText = item.locker;
                        document.getElementById('reserveForm').classList.remove('hidden');
                        document.getElementById('reserveForm').scrollIntoView({behavior: 'smooth'});
                    };
                }
                grid.appendChild(btn);
            });
        } catch (err) {
            grid.innerHTML = "<p style='color:red'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ</p>";
        }
    }

    async function doReserve() {
        const phone = document.getElementById('phoneInput').value;
        if (!/^\d{4,}$/.test(phone)) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß");
        
        const btn = event.target;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        btn.disabled = true;

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: "reserve", locker: selectedLocker, phone: phone })
            });
            alert("‚úÖ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            nav('home');
        } catch (err) {
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        } finally {
            btn.disabled = false;
        }
    }

    async function doSearch() {
        const phone = document.getElementById('phoneSearch').value;
        const resDiv = document.getElementById('searchResult');
        if (phone.length < 4) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß");
        resDiv.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=find&phone=${phone}`);
            const data = await res.json();
            if (data.found) {
                resDiv.innerHTML = `
                    <div class="status-box" style="background:#d4edda; color:#155724; border:1px solid #c3e6cb;">
                        <h2>üì¶ ‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏!</h2>
                        <p style="font-size:20px;">‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <strong>‡∏ï‡∏π‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${data.locker}</strong></p>
                        <button class="btn-success" onclick="doComplete('${data.locker}')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                    </div>
                `;
            } else {
                resDiv.innerHTML = `<div class="status-box" style="background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ</div>`;
            }
        } catch (err) {
            resDiv.innerHTML = "<p style='color:red'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>";
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏π‡πâ
    async function doComplete(lockerNo) {
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏π‡πâ ${lockerNo} ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

        const resDiv = document.getElementById('searchResult');
        resDiv.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏π‡πâ...";

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: "complete", locker: lockerNo })
            });
            alert("‚úÖ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡∏π‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç " + lockerNo + " ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠");
            nav('home'); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        } catch (err) {
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
            console.error(err);
        }
    }
</script>

</body>
</html>